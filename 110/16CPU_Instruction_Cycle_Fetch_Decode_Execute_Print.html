<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16. CPU æŒ‡ä»¤é€±æœŸ - äº’å‹•æ•™å­¸è©³è§£</title>
    <style>
        :root {
            --primary: #2563eb; /* Blue */
            --secondary: #475569; /* Slate */
            --accent: #f59e0b; /* Amber for highlights */
            --success: #10b981; /* Green */
            --danger: #ef4444; /* Red */
            --bg: #f8fafc;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg);
            color: #1e293b;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* å€å¡Šé€šç”¨æ¨£å¼ */
        .section-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
            border-left: 5px solid var(--primary);
        }

        h1 { font-size: 1.5rem; margin-top: 0; color: var(--primary); }
        h2 { font-size: 1.25rem; margin-top: 0; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 16px; display: flex; align-items: center; }
        h3 { font-size: 1.1rem; color: var(--secondary); margin-bottom: 8px; }

        /* é¡Œç›®å€ */
        .question-box {
            background-color: #eff6ff;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #bfdbfe;
        }
        .question-text { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; }
        .option { display: block; margin: 8px 0; padding: 8px 12px; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 1px solid #cbd5e1; }
        .option:hover { background-color: #f1f5f9; }
        .option.correct { background-color: #dcfce7; border-color: var(--success); color: #065f46; font-weight: bold; }
        .option.wrong { background-color: #fee2e2; border-color: var(--danger); text-decoration: line-through; opacity: 0.7; }

        /* è¢å…‰ç­†ç‰¹æ•ˆ */
        .highlight {
            background: linear-gradient(120deg, rgba(255, 255, 0, 0) 0%, rgba(255, 255, 0, 0.4) 100%);
            background-repeat: no-repeat;
            background-size: 100% 40%;
            background-position: 0 88%;
            font-weight: bold;
            color: #b91c1c;
        }

        /* äº’å‹•å‹•ç•«å€ */
        .sim-container {
            background: #1e293b;
            color: white;
            padding: 20px;
            border-radius: 12px;
            position: relative;
            min-height: 380px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .diagram-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-top: 20px;
            position: relative;
        }

        .component {
            border: 2px solid #94a3b8;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            width: 30%;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
            position: relative;
            background: rgba(255,255,255,0.05);
        }

        .component.active {
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent);
            background: rgba(245, 158, 11, 0.1);
        }

        .comp-title { font-weight: bold; margin-bottom: 5px; color: #93c5fd; }
        .comp-desc { font-size: 0.8rem; color: #cbd5e1; }

        /* å‹•ç•«å…ƒç´ ï¼šæŒ‡ä»¤ */
        #instruction-packet {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 15%; /* Start at RAM */
            transform: translate(-50%, -50%);
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            box-shadow: 0 0 10px var(--accent);
            z-index: 10;
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-reset { background: var(--secondary); color: white; }
        .btn-trap { background: transparent; border: 2px solid var(--danger); color: var(--danger); }
        .btn-trap:hover { background: var(--danger); color: white; }

        .status-display {
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 20px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #475569;
        }

        /* ç”Ÿæ´»æ¯”å–»æ–‡å­— */
        .analogy-text {
            color: #fbbf24;
            font-size: 0.9rem;
            margin-top: 5px;
            font-style: italic;
        }

        /* è§£èªªå€å¡Šæ¨£å¼ */
        .step-list { list-style: none; padding: 0; }
        .step-list li {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        .step-num {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-size: 0.9rem;
        }
        .step-content strong { color: var(--primary); }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 5px;
            font-weight: bold;
        }
        .tag-cpu { background: #dbeafe; color: #1e40af; }
        .tag-io { background: #fee2e2; color: #991b1b; }

        /* å½ˆè·³è¦–çª— */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            text-align: center;
            animation: popIn 0.3s ease;
        }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .diagram-area { flex-direction: column; gap: 20px; }
            .component { width: 80%; }
            #instruction-packet { display: none !important; } /* Simplify animation on mobile */
            .sim-container { min-height: auto; }
        }
    </style>
</head>
<body>

<div class="container">

    <!-- A. æ¨™é¡Œå€ -->
    <header style="text-align: center; margin-bottom: 30px;">
        <h1 style="margin-bottom: 5px;">é›»è…¦æ¦‚è«–ï¼šCPU æŒ‡ä»¤é€±æœŸ</h1>
        <span style="background: #e2e8f0; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; color: #475569;">å–®å…ƒï¼šé›»è…¦ç¡¬é«”æ¶æ§‹</span>
    </header>

    <!-- B. é¡Œç›®å€ -->
    <section class="section-card question-box">
        <div class="question-text">16. ä¸‹åˆ—ä½•è€…ä¸å±¬æ–¼CPUçš„åŸºæœ¬å·¥ä½œï¼Ÿ</div>
        <div class="option" onclick="checkAnswer(this, false)">(A) æ“·å–</div>
        <div class="option" onclick="checkAnswer(this, false)">(B) åŸ·è¡Œ</div>
        <div class="option" onclick="checkAnswer(this, true)">(C) åˆ—å°</div>
        <div class="option" onclick="checkAnswer(this, false)">(D) è§£ç¢¼</div>
        <div id="feedback" style="margin-top: 15px; font-weight: bold; display: none;"></div>
    </section>

    <!-- C. ç¬¬ä¸€æ­¥ï¼šæ‰¾é—œéµå­— -->
    <section class="section-card">
        <h2>ğŸ” ç¬¬ä¸€æ­¥ï¼šæ‰¾é—œéµå­—</h2>
        <p>
            ã€Œä¸‹åˆ—ä½•è€… <span class="highlight">ä¸å±¬æ–¼</span> <span class="highlight">CPU</span> çš„ <span class="highlight">åŸºæœ¬å·¥ä½œ</span>ã€
        </p>
        <p style="font-size: 0.95rem; color: var(--secondary);">
            <strong>ğŸ‘‰ ç·šç´¢ï¼š</strong> é¡Œç›®å•çš„æ˜¯ CPUï¼ˆä¸­å¤®è™•ç†å™¨ï¼‰é€™å€‹ã€Œå¤§è…¦ã€ä»½å…§è©²åšçš„äº‹ã€‚å¦‚æœæœ‰æŸå€‹é¸é …æ˜¯æ‰‹è…³ï¼ˆå‘¨é‚Šè£ç½®ï¼‰åœ¨åšçš„ï¼Œé‚£å°±æ˜¯ç­”æ¡ˆã€‚
        </p>
    </section>

    <!-- D. ç¬¬äºŒæ­¥ï¼šç™½è©±ç¿»è­¯ -->
    <section class="section-card">
        <h2>ğŸ—£ï¸ ç¬¬äºŒæ­¥ï¼šç™½è©±ç¿»è­¯</h2>
        <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent);">
            ã€ŒCPU è™•ç†äº‹æƒ…çš„åŸºæœ¬ SOP æœ‰å“ªå¹¾æ­¥ï¼Ÿå“ªä¸€å€‹æ­¥é©Ÿä¸æ˜¯å®ƒè¦ªè‡ªåšçš„ï¼Ÿã€
        </div>
    </section>

    <!-- F. äº’å‹•æ¨¡æ“¬ï¼šæŒ‡ä»¤é€±æœŸå‹•ç•« (æ”¾åœ¨è§£é¡Œæ€è·¯å‰ï¼Œå…ˆé«”é©—å†çœ‹ç†è«–) -->
    <section class="section-card" style="border-left-color: var(--accent);">
        <h2>ğŸ® äº’å‹•æ¨¡æ“¬ï¼šæŒ‡ä»¤é€±æœŸ (Instruction Cycle)</h2>
        <p style="margin-bottom: 15px; font-size:0.9rem;">è«‹è§€å¯Ÿ CPU è™•ç†æŒ‡ä»¤çš„ã€Œä¸‰æ­¥é©Ÿã€ã€‚è©¦è‘—æŒ‰æŒ‰çœ‹å³ä¸‹è§’çš„éŒ¯èª¤é¸é …ï¼</p>
        
        <div class="sim-container">
            <div class="status-display" id="sim-status">
                æº–å‚™å°±ç·’ (Idle)
                <div class="analogy-text" id="sim-analogy">ç­‰å¾…æŒ‡ä»¤ä¸­...</div>
            </div>

            <div class="diagram-area">
                <!-- è¨˜æ†¶é«” -->
                <div class="component" id="comp-ram">
                    <div class="comp-title">è¨˜æ†¶é«” (RAM)</div>
                    <div class="comp-desc">å­˜æ”¾æŒ‡ä»¤èˆ‡è³‡æ–™<br>(é£Ÿè­œ)</div>
                </div>

                <!-- å‚³è¼¸å‹•ç•«é» -->
                <div id="instruction-packet">ğŸ“„</div>

                <!-- CPU -->
                <div class="component" id="comp-cpu">
                    <div class="comp-title">CPU (ä¸­å¤®è™•ç†å™¨)</div>
                    <div class="comp-desc">
                        <span id="part-cu" style="display:block; margin:2px; padding:2px; border-radius:4px;">æ§åˆ¶å–®å…ƒ CU</span>
                        <span id="part-alu" style="display:block; margin:2px; padding:2px; border-radius:4px;">ç®—è¡“é‚è¼¯å–®å…ƒ ALU</span>
                        <span style="font-size:0.7rem; color:#64748b;">(å¤§è…¦)</span>
                    </div>
                </div>

                <!-- I/O -->
                <div class="component" id="comp-printer" style="border-style: dashed; opacity: 0.6;">
                    <div class="comp-title">å°è¡¨æ©Ÿ (Printer)</div>
                    <div class="comp-desc">è¼¸å‡ºå‘¨é‚Šè£ç½®<br>(æ‰‹/å˜´å·´)</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="btn-step" onclick="nextStep()">å–®æ­¥åŸ·è¡Œ (Step)</button>
                <button class="btn btn-primary" id="btn-play" onclick="togglePlay()">è‡ªå‹•æ’­æ”¾ â–¶</button>
                <button class="btn btn-reset" onclick="resetSim()">é‡ç½® (Reset)</button>
                <button class="btn btn-trap" onclick="triggerPrintTrap()">ğŸ–¨ï¸ åŸ·è¡Œã€Œåˆ—å°ã€</button>
            </div>
        </div>
    </section>

    <!-- E. ç¬¬ä¸‰æ­¥ï¼šè§£é¡Œæ€è·¯ -->
    <section class="section-card">
        <h2>ğŸ’¡ ç¬¬ä¸‰æ­¥ï¼šè§£é¡Œæ€è·¯</h2>
        <ul class="step-list">
            <li>
                <div class="step-num">1</div>
                <div class="step-content">
                    <strong>æ ¸å¿ƒè§€å¿µï¼š</strong>CPU çš„å·¥ä½œå°±åƒå»šå¸«åšèœï¼Œæœ‰å›ºå®šçš„å¾ªç’°æµç¨‹ã€‚
                </div>
            </li>
            <li>
                <div class="step-num">2</div>
                <div class="step-content">
                    <strong>æ¨™æº–ä¸‰æ­¥é©Ÿ (Machine Cycle)ï¼š</strong><br>
                    1. <span class="tag tag-cpu">æ“·å– Fetch</span> å»è¨˜æ†¶é«”æ‹¿æŒ‡ä»¤ã€‚<br>
                    2. <span class="tag tag-cpu">è§£ç¢¼ Decode</span> çœ‹æ‡‚æŒ‡ä»¤è¦åšä»€éº¼ã€‚<br>
                    3. <span class="tag tag-cpu">åŸ·è¡Œ Execute</span> é€²è¡Œé‹ç®—æˆ–æ§åˆ¶ã€‚
                </div>
            </li>
            <li>
                <div class="step-num">3</div>
                <div class="step-content">
                    <strong>åˆ¤æ–·é—œéµï¼š</strong>ã€Œåˆ—å°ã€æ˜¯å°‡çµæœè¼¸å‡ºåˆ°ç´™å¼µä¸Šï¼Œé€™æ˜¯<span class="tag tag-io">I/O è£ç½®</span>ï¼ˆå°è¡¨æ©Ÿï¼‰çš„å·¥ä½œï¼Œé›–ç„¶ CPU æœƒä¸‹ä»¤ï¼Œä½†ã€Œåˆ—å°ã€é€™å€‹å‹•ä½œæœ¬èº«ç™¼ç”Ÿåœ¨ CPU å¤–éƒ¨ã€‚
                </div>
            </li>
        </ul>
        <div style="background: #fffbeb; padding: 15px; border-radius: 8px; border: 1px solid #fcd34d;">
            <strong>ğŸ³ ç”Ÿæ´»æ¯”å–»ï¼šç…§é£Ÿè­œåšèœ</strong>
            <ul>
                <li><strong>æ“·å– (Fetch)ï¼š</strong>å¾æ›¸æ¶ä¸ŠæŠŠé£Ÿè­œæ‹¿ä¸‹ä¾†ã€‚</li>
                <li><strong>è§£ç¢¼ (Decode)ï¼š</strong>çœ‹æ‡‚é£Ÿè­œä¸Šå¯«ä»€éº¼ï¼ˆåˆ‡èœé‚„æ˜¯ç…®æ¹¯ï¼Ÿï¼‰ã€‚</li>
                <li><strong>åŸ·è¡Œ (Execute)ï¼š</strong>å¯¦éš›å‹•æ‰‹åˆ‡èœæˆ–ç…®æ¹¯ã€‚</li>
                <li><strong>åˆ—å° (Print)ï¼š</strong>æŠŠèœç«¯çµ¦å®¢äººåƒï¼ˆé€™æ˜¯å¤–å ´æœå‹™ç”Ÿ/è¼¸å‡ºè£ç½®çš„äº‹ï¼Œä¸æ˜¯å»šå¸«/CPU çš„æ ¸å¿ƒæ€è€ƒéç¨‹ï¼‰ã€‚</li>
            </ul>
        </div>
    </section>

    <!-- G. ç¬¬å››æ­¥ï¼šé¸é …åˆ†æ -->
    <section class="section-card">
        <h2>ğŸ§ ç¬¬å››æ­¥ï¼šé¸é …åˆ†æ</h2>
        
        <div style="margin-bottom: 15px;">
            <strong style="color: var(--primary);">(A) æ“·å– (Fetch)</strong> - <span style="color: var(--success); font-weight: bold;">å±¬æ–¼ CPU</span>
            <p style="margin: 5px 0 15px 0; font-size: 0.95rem;">
                CPU çš„ã€Œæ§åˆ¶å–®å…ƒã€è² è²¬å¾è¨˜æ†¶é«”ä¸­æŠŠæŒ‡ä»¤è®€å–åˆ° CPU å…§éƒ¨çš„ã€ŒæŒ‡ä»¤æš«å­˜å™¨ã€ä¸­ã€‚æ²’æœ‰é€™ä¸€æ­¥ï¼ŒCPU æ ¹æœ¬ä¸çŸ¥é“è¦å¹¹å˜›ã€‚
            </p>
        </div>

        <div style="margin-bottom: 15px;">
            <strong style="color: var(--primary);">(B) åŸ·è¡Œ (Execute)</strong> - <span style="color: var(--success); font-weight: bold;">å±¬æ–¼ CPU</span>
            <p style="margin: 5px 0 15px 0; font-size: 0.95rem;">
                ç”±ã€Œç®—è¡“é‚è¼¯å–®å…ƒ (ALU)ã€è² è²¬é‹ç®—ï¼Œæˆ–ç”±æ§åˆ¶å–®å…ƒç™¼é€ä¿¡è™Ÿã€‚é€™æ˜¯çœŸæ­£ã€Œåšäº‹ã€çš„éšæ®µã€‚
            </p>
        </div>

        <div style="margin-bottom: 15px;">
            <strong style="color: var(--danger);">(C) åˆ—å° (Print)</strong> - <span style="color: var(--danger); font-weight: bold;">âŒ ä¸å±¬æ–¼ CPU åŸºæœ¬ä¸‰æ­¥é©Ÿ</span>
            <p style="margin: 5px 0 15px 0; font-size: 0.95rem;">
                åˆ—å°å±¬æ–¼ã€Œè¼¸å‡º (Output)ã€ã€‚CPU ç®—å®Œçµæœå¾Œï¼ŒæœƒæŠŠè³‡æ–™é€åˆ° I/O æ§åˆ¶å™¨ï¼Œå†ç”±å°è¡¨æ©Ÿå°å‡ºä¾†ã€‚é€™å±¬æ–¼å‘¨é‚Šè¨­å‚™çš„å·¥ä½œç¯„ç–‡ã€‚
            </p>
        </div>

        <div style="margin-bottom: 15px;">
            <strong style="color: var(--primary);">(D) è§£ç¢¼ (Decode)</strong> - <span style="color: var(--success); font-weight: bold;">å±¬æ–¼ CPU</span>
            <p style="margin: 5px 0 15px 0; font-size: 0.95rem;">
                æŒ‡ä»¤æ‹¿é€²ä¾†æ˜¯äºŒé€²ä½ä»£ç¢¼ (0101...)ï¼ŒCPU å¿…é ˆå…ˆç¿»è­¯ï¼ˆè§£ç¢¼ï¼‰æ‰çŸ¥é“é€™æ˜¯åŠ æ³•ã€æ¸›æ³•é‚„æ˜¯å­˜æª”ã€‚
            </p>
        </div>
    </section>

    <!-- H. è§€å¿µè£œå……èˆ‡å»¶ä¼¸ & I. è¨˜æ†¶å£è¨£ -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <section class="section-card">
            <h3>ğŸ§  è¨˜æ†¶å£è¨£</h3>
            <p style="font-size: 1.2rem; font-weight: bold; color: var(--primary); text-align: center; margin: 20px 0;">
                ã€Œå–ã€è§£ã€åŸ·ã€
            </p>
            <p style="text-align: center;">
                æ‹¿ä¾† (Fetch) â†’ çœ‹æ‡‚ (Decode) â†’ å»åš (Execute)<br>
                <span style="font-size: 0.9rem; color: #64748b;">åˆ—å°æ˜¯æ‰‹è…³åœ¨åšçš„äº‹ï¼</span>
            </p>
        </section>

        <section class="section-card">
            <h3>âš ï¸ å¸¸è¦‹é™·é˜±</h3>
            <ul style="padding-left: 20px;">
                <li><strong>åˆ¥é¸ã€Œå„²å­˜ (Store/Write Back)ã€ï¼š</strong> é›–ç„¶å®Œæ•´çš„ç¾ä»£æŒ‡ä»¤é€±æœŸåŒ…å«ã€Œå¯«å›ã€ï¼Œä½†åœ¨ä¸‰æ­¥é©ŸåŸºæœ¬é¡Œå‹ä¸­ï¼ŒFetch/Decode/Execute æ˜¯éµä¸‰è§’ã€‚</li>
                <li><strong>è¼¸å…¥/è¼¸å‡ºæ··æ·†ï¼š</strong> çœ‹åˆ° Print(åˆ—å°)ã€Scan(æƒæ)ã€Type(æ‰“å­—)ï¼Œé€™äº›éƒ½æ˜¯ I/Oï¼Œä¸æ˜¯ CPU æ ¸å¿ƒé‹ç®—é€±æœŸã€‚</li>
            </ul>
        </section>
    </div>

</div>

<!-- äº’å‹•å½ˆçª— -->
<div class="modal-overlay" id="print-modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 style="color: var(--danger); border:none;">ğŸš« ç­”éŒ¯äº†/è§€å¿µä¿®æ­£</h2>
        <div style="font-size: 50px; margin: 10px 0;">ğŸ–¨ï¸ â‰  ğŸ§ </div>
        <p><strong>ã€Œåˆ—å° (Print)ã€å±¬æ–¼ I/O è¼¸å‡ºåŠŸèƒ½ï¼</strong></p>
        <p style="text-align: left; font-size: 0.95rem; color: #475569;">
            å°±åƒå»šå¸«ï¼ˆCPUï¼‰æŠŠèœåšå¥½äº†ï¼Œäº¤çµ¦æœå‹™ç”Ÿï¼ˆå°è¡¨æ©Ÿï¼‰ç«¯å‡ºå»ã€‚<br>
            å»šå¸«çš„å·¥ä½œå¾ªç’°æ˜¯ã€Œçœ‹å–®ã€å‚™æ–™ã€ç‚’èœã€ï¼Œç«¯ç›¤å­æ˜¯å¤–å ´çš„äº‹å–”ï¼
        </p>
        <button class="btn btn-primary" onclick="closeModal()" style="width: 100%; margin-top: 15px;">æˆ‘æ‡‚äº†ï¼</button>
    </div>
</div>

<script>
    // --- ç­”é¡Œé‚è¼¯ ---
    function checkAnswer(element, isCorrect) {
        // é‡ç½®æ‰€æœ‰é¸é …æ¨£å¼
        const options = document.querySelectorAll('.option');
        options.forEach(opt => {
            opt.classList.remove('correct', 'wrong');
            opt.style.opacity = '1';
        });

        const feedback = document.getElementById('feedback');
        feedback.style.display = 'block';

        if (isCorrect) {
            element.classList.add('correct');
            feedback.innerHTML = "<span style='color:var(--success)'>âœ… ç­”å°äº†ï¼</span> åˆ—å°æ˜¯è¼¸å‡ºè£ç½®çš„å·¥ä½œï¼Œä¸æ˜¯ CPU å…§éƒ¨çš„æŒ‡ä»¤é€±æœŸã€‚";
        } else {
            element.classList.add('wrong');
            feedback.innerHTML = "<span style='color:var(--danger)'>âŒ ç­”éŒ¯å›‰ï¼</span> é€™æ˜¯ CPU æ¯å¤©éƒ½åœ¨åšçš„åŸºæœ¬å·¥ä½œå–”ï¼Œè«‹å¾€ä¸‹çœ‹è©³è§£ï¼";
        }
    }

    // --- å‹•ç•«æ¨¡æ“¬é‚è¼¯ ---
    let currentStep = 0; // 0: Idle, 1: Fetch, 2: Decode, 3: Execute
    let isPlaying = false;
    let playInterval;

    const statusText = document.getElementById('sim-status');
    const analogyText = document.getElementById('sim-analogy');
    const compRam = document.getElementById('comp-ram');
    const compCpu = document.getElementById('comp-cpu');
    const partCu = document.getElementById('part-cu');
    const partAlu = document.getElementById('part-alu');
    const instruction = document.getElementById('instruction-packet');
    const btnPlay = document.getElementById('btn-play');

    function resetSim() {
        stopPlay();
        currentStep = 0;
        updateVisuals();
    }

    function togglePlay() {
        if (isPlaying) {
            stopPlay();
        } else {
            isPlaying = true;
            btnPlay.textContent = "æš«åœ â¸";
            btnPlay.classList.replace('btn-primary', 'btn-reset');
            // å¦‚æœå·²ç¶“åœ¨æœ€å¾Œä¸€æ­¥ï¼Œå…ˆé‡ç½®
            if(currentStep === 3) currentStep = 0;
            
            nextStep(); // é¦¬ä¸ŠåŸ·è¡Œä¸€æ­¥
            playInterval = setInterval(() => {
                nextStep();
            }, 2000); // æ¯2ç§’ä¸€æ­¥
        }
    }

    function stopPlay() {
        isPlaying = false;
        clearInterval(playInterval);
        btnPlay.textContent = "è‡ªå‹•æ’­æ”¾ â–¶";
        btnPlay.classList.replace('btn-reset', 'btn-primary');
    }

    function nextStep() {
        currentStep++;
        if (currentStep > 3) {
            currentStep = 1; // å¾ªç’°
        }
        updateVisuals();
    }

    function updateVisuals() {
        // æ¸…é™¤æ‰€æœ‰ç‹€æ…‹
        compRam.classList.remove('active');
        compCpu.classList.remove('active');
        partCu.style.backgroundColor = "transparent";
        partAlu.style.backgroundColor = "transparent";
        partCu.style.color = "inherit";
        partAlu.style.color = "inherit";
        instruction.style.display = 'none';
        instruction.style.left = '15%'; 

        switch (currentStep) {
            case 0: // Idle
                statusText.innerHTML = "æº–å‚™å°±ç·’ (Idle)";
                analogyText.innerText = "ç­‰å¾…æŒ‡ä»¤ä¸­...";
                break;

            case 1: // Fetch
                statusText.innerHTML = "æ­¥é©Ÿ 1: æ“·å– (Fetch)";
                analogyText.innerText = "ç”Ÿæ´»æ¯”å–»ï¼šå»æ›¸æ¶ä¸Šæ‹¿é£Ÿè­œ";
                compRam.classList.add('active');
                compCpu.classList.add('active'); // CPUä¹Ÿäº®å› ç‚ºå®ƒåœ¨è«‹æ±‚
                
                // å‹•ç•«ï¼šæŒ‡ä»¤å¾ RAM é£›åˆ° CPU
                instruction.style.display = 'flex';
                instruction.innerText = 'ğŸ“„';
                // ä½¿ç”¨ç°¡å–®çš„ CSS transition
                setTimeout(() => {
                    instruction.style.transition = "left 1s ease-in-out";
                    instruction.style.left = '50%'; // Move to CPU center
                }, 50);
                break;

            case 2: // Decode
                statusText.innerHTML = "æ­¥é©Ÿ 2: è§£ç¢¼ (Decode)";
                analogyText.innerText = "ç”Ÿæ´»æ¯”å–»ï¼šçœ‹æ‡‚é£Ÿè­œæ­¥é©Ÿ (åˆ‡èœ? ç…®æ¹¯?)";
                compCpu.classList.add('active');
                
                // Highlight CU
                partCu.style.backgroundColor = "#f59e0b";
                partCu.style.color = "#000";
                
                instruction.style.display = 'flex';
                instruction.style.left = '50%';
                instruction.innerText = 'ğŸ¤”'; // Thinking
                break;

            case 3: // Execute
                statusText.innerHTML = "æ­¥é©Ÿ 3: åŸ·è¡Œ (Execute)";
                analogyText.innerText = "ç”Ÿæ´»æ¯”å–»ï¼šå¯¦éš›å‹•æ‰‹åšï¼";
                compCpu.classList.add('active');
                
                // Highlight ALU
                partAlu.style.backgroundColor = "#10b981";
                partAlu.style.color = "#000";
                
                instruction.style.display = 'flex';
                instruction.style.left = '50%';
                instruction.innerText = 'âš™ï¸'; // Working
                // Pulse effect via CSS embedded or simple logic
                break;
        }
    }

    // --- é™·é˜±äº’å‹• ---
    function triggerPrintTrap() {
        stopPlay();
        document.getElementById('print-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('print-modal').style.display = 'none';
    }
</script>

</body>
</html>